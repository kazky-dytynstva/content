name: PR to `main` Branch Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check source branch is dev
        run: |
          SOURCE_BRANCH="${{ github.head_ref }}"
          if [ "$SOURCE_BRANCH" != "dev" ]; then
            echo "❌ Error: Only the 'dev' branch can be merged to main"
            echo "Current source branch: $SOURCE_BRANCH"
            exit 1
          fi
          echo "✅ Source branch is dev"
      
      - name: Check branch is not outdated
        run: |
          git fetch origin main
          MERGE_BASE=$(git merge-base HEAD origin/main)
          MAIN_HEAD=$(git rev-parse origin/main)
          
          if [ "$MERGE_BASE" != "$MAIN_HEAD" ]; then
            echo "❌ Error: Branch is outdated. Please merge main into dev first"
            echo "Merge base: $MERGE_BASE"
            echo "Main HEAD: $MAIN_HEAD"
            exit 1
          fi
          echo "✅ Branch is up to date with main"
      
      - name: Check only one PR to main exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_COUNT=$(gh pr list --base main --state open --json number --jq 'length')
          
          if [ "$PR_COUNT" -gt 1 ]; then
            echo "❌ Error: Multiple PRs to main are open ($PR_COUNT PRs)"
            echo "Only one PR to main is allowed at a time"
            gh pr list --base main --state open
            exit 1
          fi
          echo "✅ Only one PR to main is open"
      
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      
      - name: Get Dart dependencies
        working-directory: ./validation
        run: dart pub get
      
      - name: Run Dart validation script
        working-directory: ./validation
        run: dart run bin/validate_data_4.dart
