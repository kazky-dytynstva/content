import 'dart:io';
import 'dart:math';

import 'package:dto/dto.dart';
import 'package:migration/migration/from_2_to_2/add_item/base_add_helper.dart';
import 'package:migration/migration/from_2_to_2/from_2_to_2.dart';
import 'package:migration/utils/audio_util.dart';

class AddTaleHelper extends _AddTaleHelper {
  AddTaleHelper(From2to2 migration) : super(migration);

  @override
  String get taleName => 'Кресало';

  @override
  Set<TaleTag> get extraTags => {TaleTag.poem};

  @override
  CrewDto? _getCrew() => CrewDto(
        authors: [_gansAndersen],
        readers: null,
        musicians: null,
        translators: null,
        graphics: null,
      );

  @override
  ChapterAudioDto? _getAudio({
    required int chapterIndex,
  }) {
    return null;
    final data = getAudioData(audioPath(chapterIndex));
    return ChapterAudioDto(
      size: data.size,
      duration: data.duration.inMilliseconds,
    );
  }

  @override
  List<String>? _getText() => [
        'Ішов солдат по дорозі: раз, два! раз, два! Ранець за спиною, шабля при боці. Йшов він додому з війни. По дорозі пострічалась йому стара відьма. Вона була така противна: нижня губа в неї звисала аж до грудей.',
        '— Добрий вечір, солдате! Ач яка в тебе славна шабля і великий ранець, ти справжній солдат! Ну, одержиш ти зараз грошей, скільки захочеш!',
        '— Дякую тобі, стара відьмо! — сказав солдат.',
        '— Бачиш ти ондечки старе дерево? — спитала відьма і вказала на дерево, що стояло неподалечку.— Воно зовсім порожне всередині! Ти злізь нагору: побачиш там дупло, спустись через нього на самісінький низ у дерево! Я перев’яжу тебе мотузкою круг пояса і витягну назад, коли ти мені гукнеш.',
        '— А навіщо мені лізти туди в дерево? — спитав солдат.',
        '— По гроші! — відповіла відьма.— Знай, що коли дістанешся самісінького низу в дереві, то опинишся у великому підземному ході, там зовсім світло, тому що горить більше сотні ламп. Ти побачиш троє дверей, можеш їх відчинити, ключі стирчать зовні. Заходь у першу кімнату, там, посередині на підлозі, побачиш велику скриню, а на ній собаку: очі в нього завбільшки як чайні чашки! Але ти не бійся. Я дам тобі мій синій картатий фартух, розстели його на підлозі, швиденько схопи собаку і посади його на фартух, а тоді відчини скриню і бери гроші, скільки захочеш. У тій скрині тільки мідні гроші, та якщо ти хочеш срібла — йди до другої кімнати. Там сидить собака з очима, як млинарські колеса. Та ти не лякайся, посади його на мій фартух і бери гроші. А якщо тобі захочеться золота, дістанеш і його стільки, скільки зможеш віднести, зайди тільки до третьої кімнати. Але в собаки, що сидить там, кожне око, як Кругла вежа. Оце справді пес, можеш мені повірити! Тільки тобі і його нема чого страхатися. Посади його лишень на мій фартух, і він тобі нічого не зробить, от і бери собі зі скрині золота, скільки душі заманеться.',
        '— Воно непогано! — мовив солдат.— Але що ж я мушу дати тобі за це, стара відьмо? Я гадаю, щось тобі потрібно ж від мене?',
        '— Ні,— мовила відьма,— я від тебе не візьму ні копійки. Ти мені принеси тільки старе кресало, яке там забула моя бабуся, коли спускалась туди востаннє.',
        '— Ну, перев’язуй мене мотузкою!—сказав солдат.',
        '— Готово! — сказала відьма,—а ось і мій синій картатий фартух.',
        'Поліз солдат на дерево, спустився в дупло і опинився, як і казала відьма, у великому проході, де горіло кілька сотень ламп.',
        'Ось відчинив він перші двері. У! Там сидів пес і лупив на нього очима, такими завбільшки, як чайні чашки.',
        '— Нічогенький молодець! — мовив солдат, посадив його на відьомський фартух і набрав повну кишеню мідних грошей, потім закрив скриню, знов посадив на неї собаку і попрямував до другої кімнати. Ой, ой! Там сидів пес з очима, як млинарські колеса!',
        '— Нема тобі чого витрішки продавати, ще очі болітимуть! — сказав солдат, посадив і цього собаку на відьомський фартух, та коли він побачив у скрині велику купу срібла, викинув усі мідяки і набив обидві кишені і ранець самим сріблом. Тоді пішов він у третю кімнату. Ну й страхіття! У цього собаки очі були справді такі величезні, як Кругла вежа, і крутилися, зовсім як колеса.',
        '— Добрий вечір! — вимовив солдат і узяв під козирок. Такого собаки він ще ніколи не бачив! Проте солдат не став довго роздивлятися, а посадив і його долі на фартух та й відкрив скриню. Матінко рідна! Скільки там було золота! На нього він міг би купити весь Копенгаген, всіх цукрових поросят у перекупок ласощами, всіх олов’яних солдатиків, дерев’яних конячок, всі батіжки на світі! Оце справді грошей! Солдат викинув усе срібло з кишень і ранця і так набив золотом свої кишені, ранець, кашкет і чоботи, що ледь-ледь міг поворушитися. Тепер уже він мав гроші! Він посадив собаку знову на скриню, зачинив двері і гукнув:',
        '— Тягни мене нагору ти, стара відьмо!',
        '— А кресало ти взяв? — спитала відьма.',
        'Отаке! Зовсім забув! — сказав солдат, пішов і взяв кресало. Відьма витягла його нагору, і він знов опинився на шляху; його кишені, чоботи, ранець і кашкет були повнісінькі золота.',
        '— Навіщо тобі це кресало? — спитав солдат.',
        '— Це тебе не обходить,— відповіла відьма,— адже ти одержав гроші! А мені давай тільки кресало.',
        '— Дурниці!—сказав солдат.— Зразу ж мені кажи, навіщо воно тобі, а то я витягну шаблю і відрубаю тобі голову.',
        '— Не скажу,— мовила відьма.',
        'Тоді солдат відрубав їй голову. Відьма упала мертва. А солдат зсипав усі гроші в її фартух, закинув вузол на спину, сунув кресало в кишеню і попрямував до міста.',
        'Це було дуже гарне місто. Солдат зупинився в найкращій гостиниці, обрав собі найкращі кімнати, замовив найулюбленіші страви,— адже він тепер був багатий, мав стільки грошей!',
        'Служник, який чистив його чоботи, здивувався було, що у такого багатого пана такі кепські чоботи, але ж солдат ще не встиг справити собі нові. Проте другого дня він придбав собі і чоботи, і багаті вбрання.',
        'Тепер солдат став знатним паном, і йому розповіли про всі дива в цьому місті, і про короля, і про чудову принцесу, його дочку.',
        '— А як би її побачити? — спитав солдат.',
        '— Це зовсім неможливо,— сказали йому.— Вона живе у величезному мідному замку, а замок оточений високими стінами з вежами. Ніхто, крім самого короля, не сміє туди ні зайти, ні вийти звідти, бо королю напророкували, що дочка його вийде заміж за простого солдата, а королям таке подобатися не може!',
        '«От би поглянути на неї!» — подумав солдат. Та хто б йому це дозволив?',
        'Тепер він зажив дуже весело, ходив у театри, їздив кататися в королівський парк і багато грошей віддав бідним. І це було дуже добре з його боку, адже він по собі знав, як то погано, коли не маєш ані копійки в кишені. Зараз він став багатим, розкішно вдягався і придбав багато друзів; вони його називали добрим молодцем, справжнім кавалером, і це йому дуже подобалось. Але він щодня тільки витрачав гроші, а нових взяти не було звідки, і врешті у нього лишилося тільки дві монетки. Довелося перебратися йому з гарних кімнат в крихітну кімнатку аж під самісіньким дахом, самому чистити собі чоботи і латати на них дірки. Ніхто з друзів тепер його не відвідував — надто вже високо було підніматися до нього.',
        'Якось зовсім пізно увечері солдат сидів у своїй кімнатці, і у нього не було грошей навіть на свічку. Тут він згадав про маленький недогарок у кресалі, яке узяв у дуплі дерева, куди його спускала відьма. Солдат дістав кресало і недогарок і ударив по кременю, викрешуючи вогонь. Двері широко розкрились, і пес з очима, як чайні чашки, той самий, якого він бачив у підземеллі, з’явився перед ним і спитав:',
        '— Що накажеш мені, господарю?',
        '— Що таке? — здивувався солдат.— Та це ж, виходить, чудове кресало, я зможу одержати все, що захочу! Дістань мені грошей! — наказав він собаці, а той раз — і вже нема; два — знову тут, а в зубах тримає великий мішок з мідними грошима. Тоді зрозумів солдат, яке це чудесне кресало. Вдарить він один раз — прибіжить собака, який сидів на скрині з мідними грошима, вдарить двічі — прибіжить той, у кого срібло, вдарить тричі — прибіжить той, що має золото.',
        'Ну, знову солдат перебрався в прекрасні кімнати, став носити багатий одяг, і всі його друзі відразу його пізнали і полюбили знову.',
        'От якось йому спало на думку: «А дивно, що не можна побачити принцесу! Вона така красуня, кажуть усі, а яка з того користь, коли вона весь свій вік просидить у мідному замку за високими стінами з вежами. Невже мені так і не пощастить побачити її? Ану, де моє кресало?» І він ударив по кременю, і враз перед ним з’явився собака з очима, як чайні чашки завбільшки.',
        '— Воно, правда, вже зараз ніч,— мовив солдат,— але мені страшенно захотілось побачити принцесу, хоч на одненьку хвильку!',
        'Собака одразу за двері, і не встиг солдат отямитись, як він з’явився з принцесою. Принцеса сиділа у нього на спині і спала. Вона була така гарна, що кожен одразу б побачив, що це справжня принцеса. Солдат не стерпів і поцілував її — адже він був славний вояка, справжній солдат!',
        'Потім собака відніс принцесу назад, і вранці, коли король і королева пили чай, принцеса розповіла, що вночі бачила дивний сон про собаку і солдата. Ніби вона їхала верхи на собаці, а солдат поцілував її.',
        '— Оце так справді мила історія! — промовила королева.',
        'І другої ночі в спальні принцеси залишили стару фрейліну. Стара фрейліна мусила дізнатися, чи то був дійсно сон, чи може щось інше.',
        'А солдатові знову страшенно заманулось побачити прекрасну принцесу, і от вночі знову з’явився собака, схопив принцесу і помчав що є сили. Але стара фрейліна одягла непромокальні чоботи і кинулась навздогін. Побачивши, що собака з принцесою зникли в одному великому будинку, вона подумала: «Тепер я знаю, де їх шукати!» — і намалювала шматком крейди на воротях великий хрест, а потім пішла додому і лягла спати. Але собака, коли відносив принцесу додому, помітив цей хрест, узяв зразу ж шматок крейди та й понаставляв хрести на всіх воротях у місті. Це було хитро вигадано, адже тепер фрейліна не могла відшукати потрібні ворота, бо хрести були скрізь.',
        'Рано-вранці король з королевою, стара фрейліна і всі офіцери пішли дивитися, куди це принцеса їздила вночі.',
        '— Ось куди! — сказав король, побачивши перші ворота з хрестом.',
        '— Ні, ось куди, чоловіченьку,— заперечила королева, побачивши хреста на інших воротях.',
        '— Але й тут хрест… І тут! —загомоніли, дами й офіцери, бачачи хрести на всіх воротях.',
        '— Тут усі зрозуміли, що діла з цього не буде.',
        'Але королева була дуже розумною жінкою, вона вміла не тільки в каретах гуляти. Взяла вона великі золоті ножиці, порізала великий шматок шовкової матерії на клаптики і зшила малесенький гарненький мішечок. У той мішечок насипала дрібної гречаної крупи і прив’язала до спини принцеси, а потім прорізала в мішечку маленьку дірочку, щоб крупа сипалася на шлях, яким поїде принцеса.',
        'Вночі з’явився знову собака, посадив принцесу на спину і поніс до солдата. Солдат так полюбив принцесу, Що дуже бажав би стати принцом і одружитися з нею.',
        'Собака не помітив, що крупа сипалась за ним весь шлях від замку до вікна солдата, куди він стрибнув з принцесою. Вранці король і королева дізнались, куди їздила принцеса, і солдата посадили у в’язницю.',
        'От і сидів він. Ой, як там було темно й нудно! Йому сказали: «Завтра вранці тебе повісять!»',
        'Дуже невесело було це почути. А кресало своє він забув дома, в гостиниці. Вранці солдат підійшов до маленького віконечка своєї камери і став дивитись крізь грати на вулицю: народ юрбами поспішав за місто подивитись, як його вішатимуть. Били в барабани, проходили полки солдатів. Усі люди бігли, біг і хлопчик-швець в шкіряному фартусі і черевиках. Він біг галопом, і один черевик злетів з ноги і вдарився об стінку, за якою сидів солдат і дивився крізь грати.',
        '— Ей, ти, куди поспішаєш? — гукнув йому солдат.— Адже без мене справа не обійдеться, а коли ти збігаєш туди, де я жив, і принесеш мені моє кресало, я дам тобі чотири монети. Тільки одна нога тут, а друга там.',
        'Хлопчик був не проти одержати чотири монети, мерщій дременув за кресалом, віддав його солдатові, і… ну зараз почуємо, що було потім!',
        'За містом була збудована висока шибениця, а навколо стояли солдати і багато сотень тисяч народу.',
        'Король і королева сиділи на пишному троні, навпроти судді та радників.',
        'Солдат уже стояв на сходах, але коли хотіли накинути йому петлю на шию, він сказав, що перед тим, як стратити злочинця, завжди виконують якесь його невинне бажання. Він дуже хотів би викурити люлечку тютюну — адже це буде його остання люлечка на цім світі.',
        'Король не посмів відмовити в такому проханні, і солдат витяг своє кресало. Вдарив по кременю — раз, два, три! І перед ним з явились три собаки. Собака з очима, як чайні чашки, собака з очима, як млинарські колеса, і собака з очима, як Кругла вежа.',
        '— Ану, допоможіть мені визволитись з петлі! — сказав солдат.',
        'І собаки кинулись на суддів і на всіх радників, схопили того за ноги, того за ніс та й почали підкидати на кілька сажнів угору; усі попадали і порозбивались.',
        '— Не треба! — закричав король, але найбільший пес схопив його разом з королевою і підкинув угору одне за одним. Тоді солдати злякались, а весь народ закричав:',
        '— Солдатику! Будь нашим королем і одружись з прекрасною принцесою!',
        'І ось посадили солдата в королівську карету, а всі три собаки танцювали перед нею і кричали «ура!». Хлопчаки свистіли, засунувши пальці в рот. Солдати віддавали їм честь. Принцеса вийшла з свого мідного замку і стала королевою, чим була дуже задоволена!',
        'Весільний бенкет тривав цілий тиждень, і собаки теж сиділи за столом і лупали очима.',
      ];
}

abstract class _AddTaleHelper extends BaseAddHelper {
  _AddTaleHelper(From2to2 migration)
      : super(
          migration,
          addItemName: 'Tale',
          folderName: 'tales',
        );

  final spaceRegExp = RegExp('\\s+');
  late TaleDto tale;

  String getTalePath(int chapterIndex) => '$dataPath/$nextId/$chapterIndex/';

  String audioPath(int chapterIndex) => '${getTalePath(chapterIndex)}audio.mp3';

  @override
  Future<bool> validate({bool post = false}) async {
    try {
      final all = await getAll();

      final idList = all.map((e) => e.id).toSet();

      assert(
        idList.length == all.length,
        'Looks like we have duplicate',
      );

      if (!post) {
        nextId = (await _getLastId()) + 1;
      }

      final chapterIndex = 0;
      final path = getTalePath(chapterIndex);
      final dir = Directory('${path}img');
      if (!dir.existsSync()) {
        dir.createSync(recursive: true);
        migration.log('Empty folder for tale was created');
        throw Exception('Please add some content to the tale folder');
      }

      if (post) {
        final imageFile = File('${path}img/0.jpg');
        assert(
          imageFile.existsSync(),
          'Image for the tale was not found',
        );

        if (tale.tags.contains(TaleTag.audio)) {
          final audioFile = File('${path}audio.mp3');
          assert(
            audioFile.existsSync(),
            'Image for the tale was not found',
          );
        }
      }
      return true;
    } catch (e) {
      migration.log(e.toString());
      return false;
    }
  }

  Future<List<TaleDto>> getAll() async {
    final json = await migration.readJsonList(jsonPath);
    final list = json.map((e) => TaleDto.fromJson(e)).toList();
    if (originalList.isEmpty) {
      originalList.addAll(list);
    }
    return list;
  }

  Future<int> _getLastId() async {
    final people = (await getAll()).map((e) => e.id);
    return people.reduce(max);
  }

  @override
  Future<void> add() async {
    final createDateDelta = const Duration(days: 1).inMilliseconds;

    final crew = _getCrew();

    final content = _getContent();
    final tags = <TaleTag>{
      if (content.first.text != null) TaleTag.text,
      if (content.first.audio != null) TaleTag.audio,
      if (crew?.authors?.isNotEmpty == true) TaleTag.author,
    }..addAll(extraTags);

    tale = TaleDto(
      id: nextId,
      name: taleName,
      createDate: DateTime.now().millisecondsSinceEpoch + createDateDelta,
      updateDate: null,
      tags: tags,
      content: content,
      crew: crew,
      ignore: true,
    );

    final all = await getAll();
    all.add(tale);
    await saveJson(all);
  }

  String get taleName;

  CrewDto? _getCrew();

  /// Other than [Tags.author],[Tags.text],[Tags.audio]
  Set<TaleTag> get extraTags;

  List<ChapterDto> _getContent() => [
        _createChapter0(),
      ];

  ChapterDto _createChapter0() => ChapterDto(
        title: null,
        imageCount: 1,
        text: _getText()?.map((e) => e.replaceAll(spaceRegExp, ' ')).toList(),
        audio: _getAudio(chapterIndex: 0),
      );

  ChapterAudioDto? _getAudio({
    required int chapterIndex,
  });

  List<String>? _getText();
}

const int _olgaTokar = 87;
const int _oskarSandler = 86;
const int _mykolaSom = 85;
const int _tinaKarol = 84;
const int _irynaGarmash = 83;
//
// const int "Тіна Кароль" = 84;
//
// const int "Ірина Гармаш" = 83;
//
// const int "Руслан Грех" = 82;
//
// const int "Леся Горова" = 81;
//
// const int "Діна Кравцова" = 80;
//
// const int "Анна Чернявська" = 79;
//
// const int "Ніка Балаж" = 78;
//
// const int "Шарль Перро" = 77;
//
// const int "Уля " = 76;
//
// const int "Алла Мігай" = 75;
//
// const int "Емілія Саталкіна" = 74;
//
// const int "Кость Дяченко" = 73;
//
// const int "Сашко Лірник" = 72;
//
// const int "Михайло Слабошпицький" = 71;
//
// const int "Анатолій Давидов" = 70;
//
// const int "Василь Вакуленко" = 69;
//
// const int "Євгенія Бурчак" = 68;
//
// const int "Вікторія Кузьміна" = 67;
//
// const int "Тарас Сліпець" = 66;
//
// const int "Оксана Смільська" = 65;
//
// const int "Владислава Сойма = 64;
//
// const int "Анатолій Михайленко" = 63;
//
// const int "Віра Карасьова = 62;
//
// const int "Микола Стеценко" = 61;
//
// const int "Олег Буцень" = 60;
//
// const int "Мирослав Вересюк" = 59;
//
// const int "Євген Башенко = 58;
//
// const int "Костянтин Ротов" = 57;
//
// const int "Максим Незгода = 56;
//
// const int "Олександр Єрох" = 55;
//
// const int "Олена Чичик = 54;
//
// const int "Леся Борсук = 53;
//
// const int "Анастасія Ножка" = 52;
//
// const int "Юлія Антонова" = 51;
//
// const int "Андрій Антонов" = 50;
//
// const int "Джоель Гарріс" = 49;
//
// const int "Денис Проуторов" = 48;
//
// const int "Світлана Харчук" = 47;
//
// const int "Анастасія Білянська" = 46;
//
// const int "Таріна Карасівна" = 45;
//
// const int "Дмитро Соколов" = 44;
//
// const int "Керстін Шьоне" = 43;
//
// const int "Світлана Колесник = 42;
//
// const int "Забіне Больман" = 41;
//
// const int "Костянтин Ушинський" = 40;
//
// const int "Ніна Матвієнко" = 39;
//
const int _ivanFranko = 38;
const int _stepanRudanskyj = 37;
const int _leonidGlibov = 36;
const int _bratyGrim = 35;
const int _marijkaPidgiryanka = 34;
const int _myhailoStelmah = 33;
const int _valentynaYurchenko = 32;
const int _serhijTatienko = 31;
const int _mykolaSygnaivskyj = 30;
const int _irynaKyrylina = 29;
const int _dmytroPavlychko = 28;
const int _andrijMalyshko = 27;
const int _platonMajboroda = 26;
const int _nataliyaZabila = 25;
const int _annaSereda = 24;
const int _grygorijBojko = 23;
const int _marijaHorosnytska = 22;
const int _anatolijKosteckyj = 21;
const int _samuilMarshak = 20;
const int _ivanMalkovych = 19;
const int _pavloGlaovyj = 18;
const int _valentynaBajkova = 17;
const int _anatolijGrygoruk = 16;
const int _yulianTuvim = 15;
const int _vasylChuhlib = 14;
const int _yanikaTereshenko = 13;
const int _viktorPavlik = 12;
const int _jannaHoma = 11;
const int _liliyaGudz = 10;
const int _tetanaLeonteva = 9;
const int _yuliaZadorojna = 8;
const int _katerynaGavrylova = 7;
const int _mariyaSoltysSmyrnove = 6;
const int _galynaMyroslava = 5;
const int _innaYavorska = 4;
const int _vasylSuhomlynskyi = 3;
const int _oksanaKrotyuk = 2;
const int _gansAndersen = 1;
const int _lesyaUkrainka = 0;
